<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Thread - Chile en L√≠nea</title>    <link rel="icon" href="/favicon.png" type="image/png">    <link rel="stylesheet" href="styles.css">
    <style>
        .reputation-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .reputation-modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 0;
            border: 1px solid #888;
            width: 500px;
            max-width: 90%;
            border-radius: 5px;
        }
        
        .reputation-modal-header {
            background: linear-gradient(to bottom, #0066a8 0%, #005691 100%);
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            border-radius: 5px 5px 0 0;
        }
        
        .reputation-modal-body {
            padding: 20px;
        }
        
        .reputation-type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .reputation-type-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .reputation-type-btn.selected {
            transform: scale(1.05);
        }
        
        .reputation-type-btn.positive {
            border-color: #4caf50;
        }
        
        .reputation-type-btn.positive.selected {
            background: #4caf50;
            color: white;
        }
        
        .reputation-type-btn.neutral {
            border-color: #9e9e9e;
        }
        
        .reputation-type-btn.neutral.selected {
            background: #9e9e9e;
            color: white;
        }
        
        .reputation-type-btn.negative {
            border-color: #f44336;
        }
        
        .reputation-type-btn.negative.selected {
            background: #f44336;
            color: white;
        }
        
        .reputation-comment-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            min-height: 80px;
            font-family: inherit;
            margin-bottom: 15px;
        }
        
        .reputation-modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .reputation-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .reputation-btn-submit {
            background: #0066a8;
            color: white;
        }
        
        .reputation-btn-cancel {
            background: #ccc;
            color: #333;
        }
        
        .rate-user-link {
            color: #0066cc;
            text-decoration: none;
            font-size: 11px;
            cursor: pointer;
        }
        
        .rate-user-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="forum-header">
            <h1>Chile en L√≠nea</h1>
        </header>

        <!-- Banner de bienvenida -->
        <div id="welcome-banner" class="welcome-banner">
            <div class="welcome-left">
                <span class="welcome-icon">üëã</span>
                <span id="welcome-text" class="welcome-text">
                    ¬°Bienvenido a Chile en L√≠nea! 
                    <a href="/register" class="welcome-link">Reg√≠strate</a> 
                    o 
                    <a href="/login" class="welcome-link">Inicia sesi√≥n</a> 
                    para participar en la comunidad
                </span>
            </div>
            <div class="welcome-right">
                <a href="/members" class="welcome-action">üë• Lista de Miembros</a>
                <a href="/admin" id="admin-btn" class="welcome-action" style="display: none;">üõ†Ô∏è Panel de Administrador</a>
                <button id="logout-btn" class="welcome-action" style="display: none; background: none; border: none; color: #fff; cursor: pointer; font-size: 14px;">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>

        <main class="forum-container">
            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="/">Inicio</a> &raquo; 
                <a href="/category">Soporte General</a> &raquo; 
                <span id="breadcrumb-title">Cargando...</span>
            </div>

            <!-- Thread Header -->
            <div class="thread-header-section">
                <h1 id="thread-title">Cargando...</h1>
            </div>

            <!-- Thread Content -->
            <div class="thread-content-container" id="thread-content">
                <div class="loading">Cargando tema...</div>
            </div>

            <!-- Comments Section -->
            <div id="comments-section"></div>

            <!-- Reply Form -->
            <div class="reply-form-container" id="reply-form-container" style="display: none;">
                <div class="section-header">
                    <h2>Responder al tema</h2>
                </div>
                <div class="reply-form-content">
                    <textarea id="reply-content" placeholder="Escribe tu respuesta..."></textarea>
                    <div class="reply-actions">
                        <button id="submit-reply" class="btn-primary">Publicar Respuesta</button>
                        <button id="cancel-reply" class="btn-secondary">Cancelar</button>
                    </div>
                </div>
            </div>

            <!-- Reply Button -->
            <div class="reply-button-container" id="reply-button-container" style="display: none; margin-bottom: 30px;">
                <button id="show-reply-form" class="btn-reply">üí¨ Responder</button>
            </div>
        </main>
    </div>

    <script src="/auth.js"></script>
    <script>
        // Obtener el slug del thread desde la URL
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');
        let currentPostId = null;

        if (!slug) {
            document.getElementById('thread-content').innerHTML = '<div class="error">Thread no encontrado</div>';
        } else {
            // Cargar el thread
            fetch(`/api/posts/${slug}`)
                .then(response => response.json())
                .then(post => {
                    // Actualizar t√≠tulo de la p√°gina
                    document.getElementById('page-title').textContent = post.title + ' - Chile en L√≠nea';
                    document.getElementById('breadcrumb-title').textContent = post.title;
                    document.getElementById('thread-title').textContent = post.title;

                    // Formatear fecha
                    const postDate = new Date(post.createdAt);
                    const formattedDate = postDate.toLocaleDateString('es-CL', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // Formatear fecha de registro del usuario
                    const joinedDate = new Date(post.author.stats.joinedDate);
                    const formattedJoinedDate = joinedDate.toLocaleDateString('es-CL', {
                        year: 'numeric',
                        month: 'short'
                    });

                    // Renderizar el contenido del post
                    const avatarInitials = post.author.username.substring(0, 2).toUpperCase();
                    const avatarHTML = post.author.avatar 
                        ? `<div class="author-avatar" style="background-image: url(${post.author.avatar}); background-size: cover; background-position: center; width: 180px; height: 180px; border-radius: 0;"></div>`
                        : `<div class="author-avatar" style="width: 180px; height: 180px; font-size: 48px; line-height: 180px; border-radius: 0;">${avatarInitials}</div>`;
                    
                    const groupColor = post.author.userGroup?.color || '#000';
                    const groupName = post.author.userGroup?.name || 'Miembro';
                    
                    const threadContent = `
                        <div class="post-container">
                            <div class="post-author-sidebar">
                                ${avatarHTML}
                                <div class="author-name">
                                    <a href="/user/${post.author.username}" style="color: ${groupColor}; font-weight: bold;">${post.author.username}</a>
                                </div>
                                <div class="author-badge" style="background: ${groupColor}; color: white; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin: 5px 0;">${groupName}</div>
                                <div class="author-stats">
                                    <div>Mensajes: ${post.author.stats.totalPosts.toLocaleString()}</div>
                                    <div>Temas: ${post.author.stats.totalThreads.toLocaleString()}</div>
                                    <div>Fecha Registro: ${formattedJoinedDate}</div>
                                    <div>Reputaci√≥n: ${post.author.stats.reputation || 0} <a class="rate-user-link" onclick="openReputationModal(${post.authorId}, '${post.author.username}')">Evaluar Usuario</a></div>
                                </div>
                            </div>
                            
                            <div class="post-content-main">\n                                <div class="post-header">
                                    <div class="post-date">${formattedDate}</div>
                                    <div class="post-number">#1</div>
                                </div>
                                
                                <div class="post-body">
                                    ${formatContent(post.content)}
                                </div>
                                
                                <div class="post-footer">
                                    <div class="post-actions">
                                        <button class="action-btn">Citar</button>
                                        <button class="action-btn">Reportar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    document.getElementById('thread-content').innerHTML = threadContent;
                    currentPostId = post.id;
                    
                    // Cargar comentarios
                    loadComments(post.id);
                    
                    // Mostrar bot√≥n de responder
                    document.getElementById('reply-button-container').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error cargando thread:', error);
                    document.getElementById('thread-content').innerHTML = '<div class="error">Error al cargar el tema</div>';
                });
        }

        // Mostrar formulario de respuesta
        document.getElementById('show-reply-form').addEventListener('click', () => {
            document.getElementById('reply-form-container').style.display = 'block';
            document.getElementById('reply-button-container').style.display = 'none';
            document.getElementById('reply-content').focus();
        });

        // Cancelar respuesta
        document.getElementById('cancel-reply').addEventListener('click', () => {
            document.getElementById('reply-form-container').style.display = 'none';
            document.getElementById('reply-button-container').style.display = 'block';
            document.getElementById('reply-content').value = '';
        });

        // Publicar respuesta
        document.getElementById('submit-reply').addEventListener('click', async () => {
            const content = document.getElementById('reply-content').value.trim();
            
            if (!content) {
                alert('Por favor escribe una respuesta');
                return;
            }

            if (!currentPostId) {
                alert('Error: No se pudo identificar el post');
                return;
            }

            try {
                const response = await fetch(`/api/posts/${currentPostId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        content: content
                    })
                });

                if (response.ok) {
                    alert('¬°Respuesta publicada exitosamente!');
                    document.getElementById('reply-content').value = '';
                    document.getElementById('reply-form-container').style.display = 'none';
                    document.getElementById('reply-button-container').style.display = 'block';
                    // Recargar p√°gina para ver la nueva respuesta
                    location.reload();
                } else {
                    alert('Error al publicar la respuesta');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al publicar la respuesta');
            }
        });

        // Funci√≥n para cargar comentarios
        async function loadComments(postId) {
            try {
                const response = await fetch(`/api/posts/${postId}/comments`);
                const comments = await response.json();
                
                const commentsSection = document.getElementById('comments-section');
                
                if (comments.length === 0) {
                    commentsSection.innerHTML = '';
                    return;
                }
                
                let commentsHTML = '';
                comments.forEach((comment, index) => {
                    const commentDate = new Date(comment.createdAt);
                    const formattedCommentDate = commentDate.toLocaleDateString('es-CL', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const joinedDate = new Date(comment.author.createdAt);
                    const formattedJoinedDate = joinedDate.toLocaleDateString('es-CL', {
                        year: 'numeric',
                        month: 'short'
                    });
                    
                    const commentAvatarInitials = comment.author.username.substring(0, 2).toUpperCase();
                    const commentAvatarHTML = comment.author.avatar 
                        ? `<div class="author-avatar" style="background-image: url(${comment.author.avatar}); background-size: cover; background-position: center; width: 180px; height: 180px; border-radius: 0;"></div>`
                        : `<div class="author-avatar" style="width: 180px; height: 180px; font-size: 48px; line-height: 180px; border-radius: 0;">${commentAvatarInitials}</div>`;
                    
                    const commentGroupColor = comment.author.userGroup?.color || '#000';
                    const commentGroupName = comment.author.userGroup?.name || 'Miembro';
                    
                    commentsHTML += `
                        <div class="post-container">
                            <div class="post-author-sidebar">
                                ${commentAvatarHTML}
                                <div class="author-name">
                                    <a href="/user/${comment.author.username}" style="color: ${commentGroupColor}; font-weight: bold;">${comment.author.username}</a>
                                </div>
                                <div class="author-badge" style="background: ${commentGroupColor}; color: white; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin: 5px 0;">${commentGroupName}</div>
                                <div class="author-stats">
                                    <div>Mensajes: ${comment.author.stats.totalPosts.toLocaleString()}</div>
                                    <div>Temas: ${comment.author.stats.totalThreads.toLocaleString()}</div>
                                    <div>Fecha Registro: ${formattedJoinedDate}</div>
                                    <div>Reputaci√≥n: ${comment.author.stats.reputation || 0} <a class="rate-user-link" onclick="openReputationModal(${comment.authorId}, '${comment.author.username}')">Evaluar Usuario</a></div>
                                </div>
                            </div>
                            
                            <div class="post-content-main">
                                <div class="post-header">
                                    <div class="post-date">${formattedCommentDate}</div>
                                    <div class="post-number">#${index + 2}</div>
                                </div>
                                
                                <div class="post-body">
                                    ${formatContent(comment.content)}
                                </div>
                                
                                <div class="post-footer">
                                    <div class="post-actions">
                                        <button class="action-btn">Citar</button>
                                        <button class="action-btn">Reportar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                commentsSection.innerHTML = commentsHTML;
            } catch (error) {
                console.error('Error cargando comentarios:', error);
            }
        }

        // Funci√≥n para formatear el contenido con BBCode b√°sico
        function formatContent(content) {
            let formatted = content;
            
            // Convertir BBCode a HTML
            formatted = formatted.replace(/\[b\](.*?)\[\/b\]/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\[i\](.*?)\[\/i\]/g, '<em>$1</em>');
            formatted = formatted.replace(/\[u\](.*?)\[\/u\]/g, '<u>$1</u>');
            formatted = formatted.replace(/\[s\](.*?)\[\/s\]/g, '<s>$1</s>');
            formatted = formatted.replace(/\[url\](.*?)\[\/url\]/g, '<a href="$1" target="_blank">$1</a>');
            formatted = formatted.replace(/\[img\](.*?)\[\/img\]/g, '<img src="$1" alt="Image" style="max-width: 100%;">');
            formatted = formatted.replace(/\[code\](.*?)\[\/code\]/gs, '<pre><code>$1</code></pre>');
            formatted = formatted.replace(/\[quote\](.*?)\[\/quote\]/gs, '<blockquote>$1</blockquote>');
            formatted = formatted.replace(/\[color=(.*?)\](.*?)\[\/color\]/g, '<span style="color: $1">$2</span>');
            formatted = formatted.replace(/\[size=(.*?)\](.*?)\[\/size\]/g, '<span style="font-size: $1px">$2</span>');
            
            // Convertir saltos de l√≠nea
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }
        
        // Modal de reputaci√≥n
        let reputationTargetUserId = null;
        let reputationTargetUsername = null;
        let selectedReputationType = null;
        
        function openReputationModal(userId, username) {
            reputationTargetUserId = userId;
            reputationTargetUsername = username;
            selectedReputationType = null;
            
            document.getElementById('reputation-modal-username').textContent = username;
            document.getElementById('reputation-comment-input').value = '';
            
            // Limpiar selecci√≥n
            document.querySelectorAll('.reputation-type-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.getElementById('reputation-modal').style.display = 'block';
        }
        
        function closeReputationModal() {
            document.getElementById('reputation-modal').style.display = 'none';
            reputationTargetUserId = null;
            reputationTargetUsername = null;
            selectedReputationType = null;
        }
        
        function selectReputationType(type) {
            selectedReputationType = type;
            
            // Actualizar botones
            document.querySelectorAll('.reputation-type-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`.reputation-type-btn.${type}`).classList.add('selected');
        }
        
        async function submitReputation() {
            if (!selectedReputationType) {
                alert('Por favor selecciona un tipo de reputaci√≥n');
                return;
            }
            
            const comment = document.getElementById('reputation-comment-input').value.trim();
            
            try {
                const response = await fetch('/api/reputation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        toUserId: reputationTargetUserId,
                        type: selectedReputationType,
                        comment: comment || null
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Error al dar reputaci√≥n');
                }
                
                alert(`‚úì Reputaci√≥n ${selectedReputationType} enviada correctamente a ${reputationTargetUsername}`);
                closeReputationModal();
                location.reload();
            } catch (error) {
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        }
        
        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('reputation-modal');
            if (event.target === modal) {
                closeReputationModal();
            }
        };
    </script>
    
    <!-- Modal de Reputaci√≥n -->
    <div id="reputation-modal" class="reputation-modal">
        <div class="reputation-modal-content">
            <div class="reputation-modal-header">
                Evaluar a <span id="reputation-modal-username">Usuario</span>
            </div>
            <div class="reputation-modal-body">
                <div class="reputation-type-selector">
                    <button class="reputation-type-btn positive" onclick="selectReputationType('positive')">
                        ‚≠ê Positivo (+1)
                    </button>
                    <button class="reputation-type-btn neutral" onclick="selectReputationType('neutral')">
                        üî∂ Neutral (0)
                    </button>
                    <button class="reputation-type-btn negative" onclick="selectReputationType('negative')">
                        ‚õî Negativo (-1)
                    </button>
                </div>
                <textarea id="reputation-comment-input" class="reputation-comment-input" placeholder="Comentario (opcional)..."></textarea>
                <div class="reputation-modal-actions">
                    <button class="reputation-btn reputation-btn-cancel" onclick="closeReputationModal()">Cancelar</button>
                    <button class="reputation-btn reputation-btn-submit" onclick="submitReputation()">Enviar Reputaci√≥n</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
