<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Thread - Chile en LÃ­nea</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="forum-header">
            <h1>Chile en LÃ­nea</h1>
        </header>

        <!-- Banner de bienvenida -->
        <div class="welcome-banner" id="welcome-banner">
            <div class="welcome-left">
                <span class="welcome-icon">ðŸ‘‹</span>
                <span class="welcome-text">
                    Â¡Bienvenido a Chile en LÃ­nea! 
                    <a href="/register" class="welcome-link">RegÃ­strate</a> 
                    o 
                    <a href="/login" class="welcome-link">Inicia sesiÃ³n</a> 
                    para participar en la comunidad
                </span>
            </div>
            <div class="welcome-right">
                <a href="/members" class="welcome-action">ðŸ‘¥ Lista de Miembros</a>
            </div>
        </div>

        <main class="forum-container">
            <!-- Breadcrumb -->
            <div class="breadcrumb">
                <a href="/">Inicio</a> &raquo; 
                <a href="/category">Soporte General</a> &raquo; 
                <span id="breadcrumb-title">Cargando...</span>
            </div>

            <!-- Thread Header -->
            <div class="thread-header-section">
                <h1 id="thread-title">Cargando...</h1>
            </div>

            <!-- Thread Content -->
            <div class="thread-content-container" id="thread-content">
                <div class="loading">Cargando tema...</div>
            </div>

            <!-- Comments Section -->
            <div id="comments-section"></div>

            <!-- Reply Form -->
            <div class="reply-form-container" id="reply-form-container" style="display: none;">
                <div class="section-header">
                    <h2>Responder al tema</h2>
                </div>
                <div class="reply-form-content">
                    <textarea id="reply-content" placeholder="Escribe tu respuesta..."></textarea>
                    <div class="reply-actions">
                        <button id="submit-reply" class="btn-primary">Publicar Respuesta</button>
                        <button id="cancel-reply" class="btn-secondary">Cancelar</button>
                    </div>
                </div>
            </div>

            <!-- Reply Button -->
            <div class="reply-button-container" id="reply-button-container" style="display: none; margin-bottom: 30px;">
                <button id="show-reply-form" class="btn-reply">ðŸ’¬ Responder</button>
            </div>
        </main>
    </div>

    <script src="/auth.js"></script>
    <script>
        // Obtener el slug del thread desde la URL
        const urlParams = new URLSearchParams(window.location.search);
        const slug = urlParams.get('slug');
        let currentPostId = null;

        if (!slug) {
            document.getElementById('thread-content').innerHTML = '<div class="error">Thread no encontrado</div>';
        } else {
            // Cargar el thread
            fetch(`/api/posts/${slug}`)
                .then(response => response.json())
                .then(post => {
                    // Actualizar tÃ­tulo de la pÃ¡gina
                    document.getElementById('page-title').textContent = post.title + ' - Chile en LÃ­nea';
                    document.getElementById('breadcrumb-title').textContent = post.title;
                    document.getElementById('thread-title').textContent = post.title;

                    // Formatear fecha
                    const postDate = new Date(post.createdAt);
                    const formattedDate = postDate.toLocaleDateString('es-CL', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    // Formatear fecha de registro del usuario
                    const joinedDate = new Date(post.author.stats.joinedDate);
                    const formattedJoinedDate = joinedDate.toLocaleDateString('es-CL', {
                        year: 'numeric',
                        month: 'short'
                    });

                    // Renderizar el contenido del post
                    const threadContent = `
                        <div class="post-container">
                            <div class="post-author-sidebar">
                                <div class="author-avatar">
                                    ${post.author.username.substring(0, 2).toUpperCase()}
                                </div>
                                <div class="author-name">
                                    <a href="/user/${post.author.username}">${post.author.username}</a>
                                </div>
                                <div class="author-badge">FORMER STAFF</div>
                                <div class="author-stats">
                                    <div>Posts: ${post.author.stats.totalPosts.toLocaleString()}</div>
                                    <div>Threads: ${post.author.stats.totalThreads.toLocaleString()}</div>
                                    <div>Joined: ${formattedJoinedDate}</div>
                                </div>
                            </div>
                            
                            <div class="post-content-main">
                                <div class="post-header">
                                    <div class="post-date">${formattedDate}</div>
                                    <div class="post-number">#1</div>
                                </div>
                                
                                <div class="post-body">
                                    ${formatContent(post.content)}
                                </div>
                                
                                <div class="post-footer">
                                    <div class="post-actions">
                                        <button class="action-btn">Citar</button>
                                        <button class="action-btn">Reportar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    document.getElementById('thread-content').innerHTML = threadContent;
                    currentPostId = post.id;
                    
                    // Cargar comentarios
                    loadComments(post.id);
                    
                    // Mostrar botÃ³n de responder
                    document.getElementById('reply-button-container').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error cargando thread:', error);
                    document.getElementById('thread-content').innerHTML = '<div class="error">Error al cargar el tema</div>';
                });
        }

        // Mostrar formulario de respuesta
        document.getElementById('show-reply-form').addEventListener('click', () => {
            document.getElementById('reply-form-container').style.display = 'block';
            document.getElementById('reply-button-container').style.display = 'none';
            document.getElementById('reply-content').focus();
        });

        // Cancelar respuesta
        document.getElementById('cancel-reply').addEventListener('click', () => {
            document.getElementById('reply-form-container').style.display = 'none';
            document.getElementById('reply-button-container').style.display = 'block';
            document.getElementById('reply-content').value = '';
        });

        // Publicar respuesta
        document.getElementById('submit-reply').addEventListener('click', async () => {
            const content = document.getElementById('reply-content').value.trim();
            
            if (!content) {
                alert('Por favor escribe una respuesta');
                return;
            }

            if (!currentPostId) {
                alert('Error: No se pudo identificar el post');
                return;
            }

            try {
                const response = await fetch(`/api/posts/${currentPostId}/comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        content: content,
                        authorId: 1 // Usuario demo
                    })
                });

                if (response.ok) {
                    alert('Â¡Respuesta publicada exitosamente!');
                    document.getElementById('reply-content').value = '';
                    document.getElementById('reply-form-container').style.display = 'none';
                    document.getElementById('reply-button-container').style.display = 'block';
                    // Recargar pÃ¡gina para ver la nueva respuesta
                    location.reload();
                } else {
                    alert('Error al publicar la respuesta');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al publicar la respuesta');
            }
        });

        // FunciÃ³n para cargar comentarios
        async function loadComments(postId) {
            try {
                const response = await fetch(`/api/posts/${postId}/comments`);
                const comments = await response.json();
                
                const commentsSection = document.getElementById('comments-section');
                
                if (comments.length === 0) {
                    commentsSection.innerHTML = '';
                    return;
                }
                
                let commentsHTML = '';
                comments.forEach((comment, index) => {
                    const commentDate = new Date(comment.createdAt);
                    const formattedCommentDate = commentDate.toLocaleDateString('es-CL', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    const joinedDate = new Date(comment.author.createdAt);
                    const formattedJoinedDate = joinedDate.toLocaleDateString('es-CL', {
                        year: 'numeric',
                        month: 'short'
                    });
                    
                    commentsHTML += `
                        <div class="post-container">
                            <div class="post-author-sidebar">
                                <div class="author-avatar">
                                    ${comment.author.username.substring(0, 2).toUpperCase()}
                                </div>
                                <div class="author-name">
                                    <a href="/user/${comment.author.username}">${comment.author.username}</a>
                                </div>
                                <div class="author-badge">FORMER STAFF</div>
                                <div class="author-stats">
                                    <div>Posts: ${comment.author.stats.totalPosts.toLocaleString()}</div>
                                    <div>Threads: ${comment.author.stats.totalThreads.toLocaleString()}</div>
                                    <div>Joined: ${formattedJoinedDate}</div>
                                </div>
                            </div>
                            
                            <div class="post-content-main">
                                <div class="post-header">
                                    <div class="post-date">${formattedCommentDate}</div>
                                    <div class="post-number">#${index + 2}</div>
                                </div>
                                
                                <div class="post-body">
                                    ${formatContent(comment.content)}
                                </div>
                                
                                <div class="post-footer">
                                    <div class="post-actions">
                                        <button class="action-btn">Citar</button>
                                        <button class="action-btn">Reportar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                commentsSection.innerHTML = commentsHTML;
            } catch (error) {
                console.error('Error cargando comentarios:', error);
            }
        }

        // FunciÃ³n para formatear el contenido con BBCode bÃ¡sico
        function formatContent(content) {
            let formatted = content;
            
            // Convertir BBCode a HTML
            formatted = formatted.replace(/\[b\](.*?)\[\/b\]/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\[i\](.*?)\[\/i\]/g, '<em>$1</em>');
            formatted = formatted.replace(/\[u\](.*?)\[\/u\]/g, '<u>$1</u>');
            formatted = formatted.replace(/\[s\](.*?)\[\/s\]/g, '<s>$1</s>');
            formatted = formatted.replace(/\[url\](.*?)\[\/url\]/g, '<a href="$1" target="_blank">$1</a>');
            formatted = formatted.replace(/\[img\](.*?)\[\/img\]/g, '<img src="$1" alt="Image" style="max-width: 100%;">');
            formatted = formatted.replace(/\[code\](.*?)\[\/code\]/gs, '<pre><code>$1</code></pre>');
            formatted = formatted.replace(/\[quote\](.*?)\[\/quote\]/gs, '<blockquote>$1</blockquote>');
            formatted = formatted.replace(/\[color=(.*?)\](.*?)\[\/color\]/g, '<span style="color: $1">$2</span>');
            formatted = formatted.replace(/\[size=(.*?)\](.*?)\[\/size\]/g, '<span style="font-size: $1px">$2</span>');
            
            // Convertir saltos de lÃ­nea
            formatted = formatted.replace(/\n/g, '<br>');
            
            return formatted;
        }
    </script>
</body>
</html>
