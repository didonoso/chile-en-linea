<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chile en L√≠nea - Foro</title>
    <link rel="icon" href="/favicon.png" type="image/png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="forum-header">
            <h1>Chile en L√≠nea</h1>
        </header>

        <!-- Banner de bienvenida -->
        <div id="welcome-banner" class="welcome-banner">
            <div class="welcome-left">
                <span class="welcome-icon">üëã</span>
                <span id="welcome-text" class="welcome-text">
                    ¬°Bienvenido a Chile en L√≠nea! 
                    <a href="/register" class="welcome-link">Reg√≠strate</a> 
                    o 
                    <a href="/login" class="welcome-link">Inicia sesi√≥n</a> 
                    para participar en la comunidad
                </span>
            </div>
            <div class="welcome-right">
                <a href="/members" class="welcome-action">üë• Lista de Miembros</a>
                <a href="/admin" id="admin-btn" class="welcome-action" style="display: none;">üõ†Ô∏è Panel de Administrador</a>
                <button id="logout-btn" class="welcome-action" style="display: none; background: none; border: none; color: #fff; cursor: pointer; font-size: 14px;">üö™ Cerrar Sesi√≥n</button>
            </div>
        </div>

        <main class="forum-container">
            <!-- Secci√≥n de Support -->
            <div class="forum-section">
                <div class="section-header">
                    <h2>Inicio</h2>
                    <button class="toggle-btn">‚ñº</button>
                </div>

                <!-- Categor√≠as se cargar√°n din√°micamente -->
                <div id="categories-container">
                    <div style="text-align: center; padding: 20px; color: #666;">Cargando categor√≠as...</div>
                </div>
            </div>

            <!-- Board Statistics -->
            <div class="forum-section">
                <div class="section-header">
                    <h2>Estad√≠sticas del Foro</h2>
                </div>
                <div class="board-statistics">
                    <p>Nuestros miembros han creado un total de <strong id="total-posts-stat">0</strong> mensajes en <strong id="total-threads-stat">0</strong> temas.</p>
                    <p>Actualmente tenemos <strong id="total-members-stat">0</strong> miembros registrados.</p>
                    <p>Por favor dale la bienvenida a nuestro miembro m√°s reciente, <a href="#" id="newest-member-link"><strong id="newest-member-stat">Cargando...</strong></a></p>
                    <p>La mayor cantidad de usuarios en l√≠nea fue <strong id="most-online-stat">0</strong> el <strong id="most-online-date">--</strong></p>
                </div>
            </div>

            <!-- User Groups -->
            <div class="forum-section">
                <div class="section-header">
                    <h2>Grupos de Usuarios</h2>
                </div>
                <div id="groups-container" class="user-groups-container">
                    <div style="text-align: center; padding: 20px; color: #666;">Cargando grupos...</div>
                </div>
            </div>
        </main>
    </div>
    <script src="/auth.js"></script>
    <script>
        // Cargar categor√≠as desde la API
        async function loadCategories() {
            try {
                const [categoriesResponse, statsResponse] = await Promise.all([
                    fetch('/api/categories'),
                    fetch('/api/stats')
                ]);
                
                const categories = await categoriesResponse.json();
                const stats = await statsResponse.json();
                
                const container = document.getElementById('categories-container');
                
                if (categories.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No hay categor√≠as disponibles</div>';
                    return;
                }
                
                container.innerHTML = categories.map(category => {
                    const postCount = category._count?.posts || 0;
                    
                    return `
                        <div class="category-row">
                            <div class="category-icon">
                                <div class="icon-circle"></div>
                            </div>
                            
                            <div class="category-info">
                                <a href="/category?id=${category.id}"><h3 class="category-title">${category.name}</h3></a>
                                <p class="category-description">${category.description || ''}</p>
                            </div>

                            <div class="category-stats">
                                <div class="stat">
                                    <span class="stat-number">${(postCount + (stats.posts || 0)).toLocaleString()}</span>
                                    <span class="stat-label">Mensajes</span>
                                </div>
                                <div class="stat">
                                    <span class="stat-number">${postCount.toLocaleString()}</span>
                                    <span class="stat-label">Temas</span>
                                </div>
                            </div>

                            <div class="category-latest">
                                <div class="latest-post">
                                    ${stats.latestPost ? `
                                        <a href="/thread?slug=${stats.latestPost.slug}" class="latest-post-title">${stats.latestPost.title}</a>
                                        <div class="latest-post-meta">
                                            <span class="latest-post-time">${getTimeAgo(new Date(stats.latestPost.createdAt))}</span>
                                            <span class="latest-post-author">por <a href="/user/${stats.latestPost.author}">${stats.latestPost.author}</a></span>
                                        </div>
                                    ` : '<span style="color: #666;">No hay mensajes a√∫n</span>'}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Cargar estad√≠sticas del foro
                loadBoardStats(stats);
                
            } catch (error) {
                console.error('Error cargando categor√≠as:', error);
                document.getElementById('categories-container').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #d32f2f;">Error al cargar las categor√≠as</div>';
            }
        }
        
        function loadBoardStats(stats) {
            if (stats.boardStats) {
                document.getElementById('total-posts-stat').textContent = stats.boardStats.totalPosts.toLocaleString();
                document.getElementById('total-threads-stat').textContent = stats.boardStats.totalThreads.toLocaleString();
                document.getElementById('total-members-stat').textContent = stats.boardStats.totalMembers.toLocaleString();
                document.getElementById('newest-member-stat').textContent = stats.boardStats.newestMember || 'N/A';
                document.getElementById('newest-member-link').href = `/user/${stats.boardStats.newestMember}`;
                document.getElementById('most-online-stat').textContent = stats.boardStats.mostOnline || 0;
                document.getElementById('most-online-date').textContent = stats.boardStats.mostOnlineDate || '--';
            }
        }
        
        // Cargar categor√≠as al iniciar
        loadCategories();
        
        // Cargar grupos de usuarios
        async function loadUserGroups() {
            try {
                const response = await fetch('/api/groups');
                const groups = await response.json();
                
                const container = document.getElementById('groups-container');
                
                if (groups.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No hay grupos disponibles</div>';
                    return;
                }
                
                container.innerHTML = groups
                    .sort((a, b) => a.order - b.order)
                    .map(group => {
                        const userCount = group._count?.users || 0;
                        const colorStyle = group.color ? `color: ${group.color};` : '';
                        
                        return `
                            <a href="/group?id=${group.id}" class="user-group-badge" style="${colorStyle}">
                                <span class="group-name">${group.name}</span>
                                <span class="group-count">(${userCount})</span>
                            </a>
                        `;
                    }).join('');
                    
            } catch (error) {
                console.error('Error cargando grupos:', error);
                document.getElementById('groups-container').innerHTML = 
                    '<div style="text-align: center; padding: 20px; color: #d32f2f;">Error al cargar los grupos</div>';
            }
        }
        
        // Cargar grupos al iniciar
        loadUserGroups();
        
        // Funci√≥n para calcular tiempo relativo
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            const intervals = {
                a√±o: 31536000,
                mes: 2592000,
                semana: 604800,
                d√≠a: 86400,
                hora: 3600,
                minuto: 60
            };
            
            for (const [name, secondsInInterval] of Object.entries(intervals)) {
                const interval = Math.floor(seconds / secondsInInterval);
                if (interval >= 1) {
                    return `hace ${interval} ${name}${interval !== 1 ? 's' : ''}`;
                }
            }
            return 'hace un momento';
        }
    </script>
</body>
</html>
